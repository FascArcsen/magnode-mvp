generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//
// ============================================================
// 🔗 MAIN ENTITY: PLATFORM CONNECTIONS
// ============================================================
// Cada registro representa una conexión OAuth o API configurada
// por una organización con un proveedor (Slack, Google, HubSpot, etc.)
//
model platform_connections {
  connection_id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  org_id                   String
  platform_type            String
  platform_name            String
  auth_config              Json?
  connector_config         Json?
  status                   String?   @default("inactive") // inactive | active | error
  last_sync_at             DateTime? @db.Timestamptz(6)
  next_sync_at             DateTime? @db.Timestamptz(6)
  sync_frequency_minutes   Int?      @default(60)
  total_records_synced     Int?      @default(0)
  total_audit_logs_created Int?      @default(0)
  error_message            String?
  created_at               DateTime? @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  raw_platform_data   raw_platform_data[]
  sync_results        sync_results[]
  llm_assisted_configs llm_assisted_configs[]

  // Índice único para evitar duplicados por proveedor
  @@unique([org_id, platform_name])
}

//
// ============================================================
// 🧩 RAW PLATFORM DATA
// ============================================================
// Datos crudos obtenidos durante las sincronizaciones de API.
// Cada payload se almacena para trazabilidad y auditoría.
//
model raw_platform_data {
  raw_data_id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  connection_id       String?   @db.Uuid
  endpoint_id         String
  raw_payload         Json
  extracted_at        DateTime? @default(now()) @db.Timestamptz(6)
  processed           Boolean?  @default(false)
  mapped_to_audit_log Boolean?  @default(false)
  audit_log_ids       String[]  @db.Uuid
  processing_errors   Json?
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  updated_at          DateTime? @default(now()) @updatedAt @db.Timestamptz(6)

  // Relación inversa
  platform_connection platform_connections? @relation(fields: [connection_id], references: [connection_id], onDelete: Cascade)
}

//
// ============================================================
// 🔄 SYNC RESULTS
// ============================================================
// Registro de cada ejecución de sincronización
// Incluye métricas de duración, estado, errores y estadísticas.
//
model sync_results {
  sync_id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  connection_id  String?   @db.Uuid
  started_at     DateTime? @default(now()) @db.Timestamptz(6)
  completed_at   DateTime? @db.Timestamptz(6)
  duration_ms    Int?
  status         String?   @default("pending") // pending | running | success | failed
  stats          Json?
  errors         Json?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @updatedAt @db.Timestamptz(6)

  // Relación inversa
  platform_connection platform_connections? @relation(fields: [connection_id], references: [connection_id], onDelete: Cascade)
}

//
// ============================================================
// 🤖 LLM-ASSISTED CONFIGS
// ============================================================
// Configuraciones sugeridas por IA (Claude / Anthropic)
// para generar automáticamente mappings de APIs.
//
model llm_assisted_configs {
  config_id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  connection_id     String?  @db.Uuid
  input             String
  suggested_config  Json?
  confidence_score  Float?
  warnings          Json?
  suggestions       Json?
  status            String?  @default("draft") // draft | validated | rejected
  user_approved     Boolean  @default(false)
  llm_model         String?
  prompt_tokens     Int?
  completion_tokens Int?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relación inversa
  platform_connection platform_connections? @relation(fields: [connection_id], references: [connection_id], onDelete: SetNull)
}